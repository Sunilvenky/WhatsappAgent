name: Train ML Models

on:
  schedule:
    # Every Sunday at 2 AM UTC
    - cron: '0 2 * * 0'
  
  # Allow manual triggering
  workflow_dispatch:
    inputs:
      model:
        description: 'Model to train (all, lead_scoring, churn, engagement)'
        required: false
        default: 'all'

jobs:
  train-models:
    runs-on: ubuntu-latest
    
    env:
      PYTHON_VERSION: '3.10'
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      MIN_ACCURACY_THRESHOLD: 0.75
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v3
      
      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r apps/api/requirements.txt
      
      - name: ğŸ—„ï¸ Wait for database
        run: |
          echo "Waiting for database to be ready..."
          sleep 10
      
      - name: ğŸ“ Train ML models
        id: train
        run: |
          echo "Starting ML model training..."
          
          if [ "${{ github.event.inputs.model }}" = "" ]; then
            MODEL="all"
          else
            MODEL="${{ github.event.inputs.model }}"
          fi
          
          echo "Training model: $MODEL"
          python -m apps.api.app.ml.train_models $MODEL > training_log.txt 2>&1
          
          # Check if training succeeded
          if [ $? -eq 0 ]; then
            echo "âœ… Training completed successfully"
            echo "training_success=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Training failed"
            echo "training_success=false" >> $GITHUB_OUTPUT
            cat training_log.txt
            exit 1
          fi
      
      - name: ğŸ§ª Test trained models
        if: steps.train.outputs.training_success == 'true'
        id: test
        run: |
          echo "Testing trained models..."
          python -m apps.api.app.ml.test_models > test_log.txt 2>&1
          
          # Check if testing succeeded
          if [ $? -eq 0 ]; then
            echo "âœ… All tests passed"
            echo "test_success=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Tests failed"
            echo "test_success=false" >> $GITHUB_OUTPUT
            cat test_log.txt
            exit 1
          fi
      
      - name: ğŸ“Š Extract metrics
        if: steps.test.outputs.test_success == 'true'
        id: metrics
        run: |
          echo "Extracting model metrics..."
          
          # Parse training log for metrics
          # (In production, save metrics to structured format like JSON)
          
          echo "metrics_extracted=true" >> $GITHUB_OUTPUT
      
      - name: ğŸ’¾ Upload trained models
        if: steps.test.outputs.test_success == 'true'
        uses: actions/upload-artifact@v3
        with:
          name: trained-models-${{ github.run_number }}
          path: |
            apps/api/app/ml/trained_models/*.pkl
          retention-days: 30
      
      - name: ğŸ“ Upload logs
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: training-logs-${{ github.run_number }}
          path: |
            training_log.txt
            test_log.txt
          retention-days: 7
      
      - name: ğŸ“§ Notify on success
        if: steps.test.outputs.test_success == 'true'
        run: |
          echo "ğŸ‰ ML model training completed successfully!"
          echo "Models trained and tested successfully"
          echo "Run: ${{ github.run_number }}"
          echo "Trigger: ${{ github.event_name }}"
          
          # In production, send email/Slack notification
      
      - name: ğŸš¨ Notify on failure
        if: failure()
        run: |
          echo "âŒ ML model training failed!"
          echo "Check logs for details"
          echo "Run: ${{ github.run_number }}"
          echo "Trigger: ${{ github.event_name }}"
          
          # In production, send email/Slack notification

  deploy-models:
    needs: train-models
    runs-on: ubuntu-latest
    if: success()
    
    steps:
      - name: ğŸ“¥ Download trained models
        uses: actions/download-artifact@v3
        with:
          name: trained-models-${{ github.run_number }}
          path: trained_models
      
      - name: ğŸš€ Deploy to production
        run: |
          echo "Deploying models to production..."
          
          # In production:
          # - Upload to S3/Cloud Storage
          # - Update model registry
          # - Trigger API server reload
          # - Run smoke tests
          
          echo "âœ… Models deployed successfully"
      
      - name: ğŸ“Š Update monitoring dashboard
        run: |
          echo "Updating monitoring dashboard..."
          
          # In production:
          # - Log metrics to time-series database
          # - Update Grafana dashboard
          # - Set up alerts
          
          echo "âœ… Dashboard updated"
